-- MT Message ODS table (source of incoming messages)
CREATE TABLE mt_message_ods (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    raw_message TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'NEW',
    retry_count INT NOT NULL DEFAULT 0,
    error_reason TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ods_status ON mt_message_ods(status);

-- Aggregation header
CREATE TABLE mt_aggregation (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    statement_number VARCHAR(50) NOT NULL,
    account_number VARCHAR(50) NOT NULL,
    message_type VARCHAR(10) NOT NULL,
    total_pages INT NOT NULL,
    received_pages INT NOT NULL DEFAULT 0,
    status VARCHAR(20) NOT NULL DEFAULT 'IN_PROGRESS',
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_agg_stmt_acct ON mt_aggregation(statement_number, account_number, message_type);

-- Aggregation pages
CREATE TABLE mt_aggregation_page (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    aggregation_id BIGINT NOT NULL,
    page_number INT NOT NULL,
    raw_message TEXT,
    checksum VARCHAR(64),
    ods_message_id BIGINT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_agg_page FOREIGN KEY (aggregation_id) REFERENCES mt_aggregation(id),
    CONSTRAINT uq_agg_page UNIQUE (aggregation_id, page_number)
);

-- Routing rules
CREATE TABLE routing_rule (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    account_number VARCHAR(50),
    message_type VARCHAR(10),
    sender_bic VARCHAR(20),
    receiver_bic VARCHAR(20),
    destination_queue VARCHAR(100) NOT NULL,
    active BOOLEAN NOT NULL DEFAULT TRUE,
    batch_id VARCHAR(50),
    source VARCHAR(10) NOT NULL DEFAULT 'UI',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_route_lookup ON routing_rule(account_number, message_type, active);

-- Relay configuration
CREATE TABLE relay_config (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    account_number VARCHAR(50),
    sender_bic VARCHAR(20),
    receiver_bic VARCHAR(20),
    active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_relay_lookup ON relay_config(account_number, sender_bic, active);
