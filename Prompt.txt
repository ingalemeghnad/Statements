üî∑ CONTEXT

Build a Spring Boot 3 (Java 17) standalone MT statement processing service.

Supported message types:
	‚Ä¢	MT940
	‚Ä¢	MT941
	‚Ä¢	MT942
	‚Ä¢	MT950

The service must:
	1.	Ingest MT messages from ODS (strategy pluggable: polling/event)
	2.	Parse MT messages
	3.	Perform 1-hour aggregation for multi-page statements
	4.	Apply routing rules (file + CRUD API)
	5.	Apply relay configuration (separate table)
	6.	Deliver messages (mock delivery for POC)
	7.	Include sample data to test end-to-end locally

Deploy as a single service with modular structure.

‚∏ª

üî∑ HIGH-LEVEL FLOW

ODS ‚Üí IngestionStrategy ‚Üí Parser ‚Üí Aggregation ‚Üí Routing ‚Üí Delivery
                                  ‚Üò Scheduler (expiry)
Rule File ‚Üí Rule Loader ‚Üí RoutingRule table
CRUD API ‚Üí RoutingRule + RelayConfig tables

Routing and Relay decisions both apply independently.

‚∏ª

üî∑ INGESTION STRATEGY (PLUGGABLE)

Define interface:

public interface MtIngestionStrategy {
    void start();
}

Provide:
	1.	PollingOdsIngestionStrategy (fully implemented)
	2.	EventDrivenOdsIngestionStrategy (POC stub only)

Property:

mt.ingestion.mode=POLLING|EVENT

Polling mode:
	‚Ä¢	Batch size configurable (default 200)
	‚Ä¢	Poll interval configurable (default 5 seconds)
	‚Ä¢	Uses:

SELECT *
FROM mt_message_ods
WHERE status = 'NEW'
ORDER BY id
FOR UPDATE SKIP LOCKED
LIMIT :batchSize;

Mark rows PROCESSING before processing.

‚∏ª

üî∑ ODS TABLE (AUTO-CREATED VIA FLYWAY)

mt_message_ods
---------------
id BIGSERIAL PRIMARY KEY
raw_message TEXT
status VARCHAR(20)
retry_count INT
error_reason TEXT
created_at TIMESTAMP
updated_at TIMESTAMP

Statuses:
	‚Ä¢	NEW
	‚Ä¢	PROCESSING
	‚Ä¢	COMPLETED
	‚Ä¢	FAILED

‚∏ª

üî∑ MT PARSER

Parse:
	‚Ä¢	:20:
	‚Ä¢	:25:
	‚Ä¢	:28C:
	‚Ä¢	Sender BIC
	‚Ä¢	Receiver BIC
	‚Ä¢	Message Type

Return:

MtStatement {
   messageType
   accountNumber
   statementNumber
   pageNumber
   totalPages
   senderBic
   receiverBic
   transactionReference
   rawMessage
}


‚∏ª

üî∑ AGGREGATION MODULE

Requirements:
	‚Ä¢	DB-backed
	‚Ä¢	1-hour expiry
	‚Ä¢	Optimistic locking
	‚Ä¢	Duplicate page detection via checksum
	‚Ä¢	Scheduler every 60 sec

Entities:

MtAggregation
MtAggregationPage

AggregationResult:

class AggregationResult {
   boolean rejected;
   boolean readyForRouting;
   MtStatement combinedStatement;
}

Timeout handling:
	‚Ä¢	Mark REJECTED
	‚Ä¢	Update ODS row to FAILED

‚∏ª

üî∑ ROUTING MODULE

RoutingRule Table

routing_rule
-------------
id
account_number
message_type
sender_bic
receiver_bic
destination_queue
active
batch_id
source (FILE | UI)
created_at
updated_at

RelayConfig Table

relay_config
--------------
id
account_number
sender_bic
receiver_bic
active
created_at
updated_at

RoutingService must:
	‚Ä¢	Cache routing rules
	‚Ä¢	Cache relay configs
	‚Ä¢	Evaluate both independently
	‚Ä¢	Produce:

DeliveryInstruction {
   List<String> downstreamDestinations;
   boolean relayToSwift;
}

Rule evaluation logic:

destinations = matching routing_rule rows
relayToSwift = matching relay_config exists

Both can apply simultaneously.

‚∏ª

üî∑ RULE LOADER
	‚Ä¢	Reads CSV file from configurable directory
	‚Ä¢	Runs daily OR triggered via REST endpoint (for POC)
	‚Ä¢	Only replaces FILE-based rules
	‚Ä¢	Does not delete UI rules
	‚Ä¢	Transactional batch replace
	‚Ä¢	Clears routing cache after load

Provide sample CSV in project resources.

‚∏ª

üî∑ CRUD APIs

Routing Rules

POST   /api/routing-rules
PUT    /api/routing-rules/{id}
GET    /api/routing-rules
DELETE /api/routing-rules/{id}

Relay Config

POST   /api/relay-config
PUT    /api/relay-config/{id}
GET    /api/relay-config
DELETE /api/relay-config/{id}

Add basic in-memory security for POC.

‚∏ª

üî∑ DELIVERY MODULE (POC WITHOUT MQ)

Define:

interface DeliveryAdapter

Implement:
	1.	MockDeliveryAdapter (default)
	‚Ä¢	Stores delivered messages in in-memory list
	‚Ä¢	Logs deliveries
	‚Ä¢	Expose:

GET /test/deliveries

to view deliveries

	2.	MqDeliveryAdapter (config-only stub for future)

Property:

mt.delivery.mode=MOCK|MQ

DeliveryService:
	‚Ä¢	Async
	‚Ä¢	Retry 3 times
	‚Ä¢	Separate thread pool
	‚Ä¢	Relay uses same adapter but destination = SWIFT.RELAY

‚∏ª

üî∑ SAMPLE DATA GENERATION (IMPORTANT)

At application startup (via CommandLineRunner or data.sql):

Insert:

1Ô∏è‚É£ Sample ODS Messages
	‚Ä¢	Single-page MT940
	‚Ä¢	Multi-page MT940 (2 pages)
	‚Ä¢	MT942 example

Include valid SWIFT MT format in raw_message field.

Example minimal MT940 sample:

{1:F01BANKGB22AXXX0000000000}{2:I940CLIENTBICXXXXN}{4:
:20:REF123
:25:123456789
:28C:00001/001
:60F:C210101EUR1000,
:61:2101010101DR100,
:62F:C210101EUR900,
-}

Multi-page example:

Page 1:
:28C:00002/001

Page 2:
:28C:00002/002

‚∏ª

2Ô∏è‚É£ Sample Routing Rules

Insert:
	‚Ä¢	Rule for account 123456789
	‚Ä¢	MessageType MT940
	‚Ä¢	Destination REPORTING.Q1

‚∏ª

3Ô∏è‚É£ Sample Relay Config

Insert:
	‚Ä¢	account 123456789
	‚Ä¢	sender BANKGB22
	‚Ä¢	receiver CLIENTBICXXXX

‚∏ª

üî∑ END-TO-END TEST REQUIREMENT

Provide integration test:
	1.	Insert sample ODS row
	2.	Trigger polling
	3.	Assert:
	‚Ä¢	Aggregation works
	‚Ä¢	Routing applied
	‚Ä¢	MockDeliveryAdapter contains:
	‚Ä¢	REPORTING.Q1
	‚Ä¢	SWIFT.RELAY (because relay config exists)

Also provide test for:
	‚Ä¢	Aggregation timeout
	‚Ä¢	CRUD rule update
	‚Ä¢	File rule load

‚∏ª

üî∑ METRICS

Expose via Actuator:
	‚Ä¢	mt.ingestion.processed
	‚Ä¢	mt.aggregation.completed
	‚Ä¢	mt.aggregation.rejected
	‚Ä¢	mt.routing.cache.hit
	‚Ä¢	mt.delivery.success
	‚Ä¢	mt.delivery.failure

‚∏ª

üî∑ THREAD POOLS

Define configurable executors:
	‚Ä¢	ingestionExecutor
	‚Ä¢	aggregationExecutor
	‚Ä¢	deliveryExecutor

‚∏ª

üî∑ PROJECT STRUCTURE

com.bank.mt

  ingestion/
  parsing/
  aggregation/
  routing/
  ruleloader/
  delivery/
  controller/
  repository/
  scheduler/
  domain/
  config/
  test/


‚∏ª

üî∑ OUTPUT EXPECTATION

Generate:
	‚Ä¢	Complete runnable Spring Boot project
	‚Ä¢	Flyway migration scripts
	‚Ä¢	application.yml
	‚Ä¢	Sample CSV rule file
	‚Ä¢	Sample ODS data insert script
	‚Ä¢	All modules
	‚Ä¢	Mock delivery adapter
	‚Ä¢	Integration tests
	‚Ä¢	Clear architectural comments
	‚Ä¢	README explaining how to run locally

The project must run locally with:

./mvnw spring-boot:run

And allow testing via:

GET /test/deliveries

No external MQ required.
